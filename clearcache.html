<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>System Update - ORSYS-ARY</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background: #f4f7f6; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; }
.card { padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px; }
</style>
</head>
<body>
<div class="card">
<div class="spinner-border text-primary mb-3" role="status"></div>
<h4>Updating Application</h4>
<p class="text-muted" id="msg">Initializing cache wipe...</p>
</div>

<script>
    async function forceUpdate() {
        const msg = document.getElementById('msg');
        
        // 1. Clear Cache Storage API (Wipes the files sw.js saved)
        if ('caches' in window) {
            try {
                const keys = await caches.keys();
                await Promise.all(keys.map(key => caches.delete(key)));
                console.log('Cache Storage cleared');
            } catch (e) { console.error('Cache wipe error', e); }
        }

        // 2. Unregister Service Workers
        if ('serviceWorker' in navigator) {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    await reg.unregister();
                    console.log('SW unregistered');
                }
            } catch (e) { 
                console.warn('SW unregister failed, likely already gone or invalid state.');
            }
        }

        msg.innerText = "System cleared. Redirecting to fresh version...";

        // 3. Hard Reload with Cache Buster
        // Adding a random query string (?v=...) forces the server to provide a new file
        setTimeout(() => {
            window.location.href = window.location.origin + window.location.pathname + '?v=' + Date.now();
        }, 1500);
    }

    window.addEventListener('load', forceUpdate);
</script>


</body>
</html>