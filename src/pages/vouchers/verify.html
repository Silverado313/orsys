<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORSYS-ARY - Receipt Verification</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/src/styles/voucher.css">

    <style>
        /* Rate limit shield — prevents rapid repeated queries */
        body { background: #f8f9fa; }

        .verify-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            padding-top: 3rem;
        }

        .attempt-warning {
            display: none;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.88rem;
            color: #856404;
            margin-top: 0.75rem;
        }

        .locked-msg {
            display: none;
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.88rem;
            color: #842029;
            margin-top: 0.75rem;
        }
    </style>
</head>
<body>

    <div class="verify-wrapper container">
        <div class="row justify-content-center w-100">
            <div class="col-md-8">
                <div class="search-box">
                    <h2 class="text-center mb-4">
                        <i class="fas fa-check-circle me-2"></i>Verify Receipt
                    </h2>
                    <p class="text-center mb-4 text-muted">
                        Enter the receipt slip number to verify its authenticity
                    </p>

                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg"
                               id="slipNumber" placeholder="Enter Slip Number"
                               maxlength="30" autocomplete="off">
                        <button class="btn btn-primary" type="button" id="verifyBtn">
                            <i class="fas fa-search me-2"></i>Verify
                        </button>
                    </div>

                    <!-- Attempt warning (shown after 3 failed tries) -->
                    <div class="attempt-warning" id="attemptWarning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="attemptMsg"></span>
                    </div>

                    <!-- Locked message (shown after 5 failed tries) -->
                    <div class="locked-msg" id="lockedMsg">
                        <i class="fas fa-lock me-2"></i>
                        Too many failed attempts. Please wait <strong id="lockTimer">60</strong> seconds.
                    </div>

                    <div id="alert-container"></div>
                </div>

                <!-- Verification Result -->
                <div id="verification-result" class="d-none">
                    <div class="verification-status" id="status-message"></div>

                    <div class="receipt-container">
                        <div class="receipt-header">
                            <h3>OFFICIAL RECEIPT VOUCHER</h3>
                            <p class="mb-0">ORSYS-ARY Receipt System</p>
                        </div>

                        <div class="receipt-details">
                            <div class="row">
                                <div class="col-6">
                                    <p><strong>Slip No:</strong> <span id="result-slipNo">-</span></p>
                                    <p><strong>Payment From:</strong> <span id="result-paymentFrom">-</span></p>
                                    <p><strong>Point Person:</strong> <span id="result-pointPerson">-</span></p>
                                    <p><strong>Payment Mode:</strong> <span id="result-paymentMode">-</span></p>
                                </div>
                                <div class="col-6">
                                    <p><strong>Cell:</strong> <span id="result-cell">-</span></p>
                                    <p><strong>Date:</strong> <span id="result-date">-</span></p>
                                    <p><strong>Payment Status:</strong> <span id="result-paymentStatus">-</span></p>
                                    <p><strong>User:</strong> <span id="result-user">-</span></p>
                                </div>
                            </div>

                            <p><strong>Remarks:</strong> <span id="result-remarks">-</span></p>

                            <h5 class="mt-4">Denomination Breakdown</h5>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Denomination</th>
                                        <th>Count</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="result-denominations"></tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <th colspan="2">Total Cash</th>
                                        <th id="result-totalCash">0.00</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="receipt-footer">
                            <p>Thank you for your payment!</p>
                            <p class="mb-0">Generated by ORSYS-ARY Receipt System</p>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3">
                        <button id="print-receipt" class="btn btn-success me-md-2">
                            <i class="fas fa-print me-2"></i>Print Receipt
                        </button>
                        <button id="verify-another" class="btn btn-outline-primary">
                            <i class="fas fa-search me-2"></i>Verify Another
                        </button>
                    </div>
                    <br><br>
                </div>

            </div>
        </div>
    </div>

    <!-- Firebase Configuration Loader -->
    <script src="/src/scripts/config/configLoader.js"></script>

    <!-- Input Validation -->
    <script src="/src/scripts/config/validation.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ================================================================
    // SECURE PUBLIC VERIFY SCRIPT
    // Replaces: /src/scripts/vouchers/slipverify.js
    //
    // Security measures applied:
    // 1. Input sanitization — strips special characters
    // 2. Rate limiting — max 5 attempts, then 60s lockout
    // 3. Query limited to slipNo field only (.where + .limit(1))
    // 4. Only safe fields shown to public (no internal metadata)
    // ================================================================

    // --- Rate Limit State ---
    let attempts     = 0;
    const MAX_TRIES  = 5;
    const WARN_AFTER = 3;
    let locked       = false;
    let lockInterval = null;

    // --- Wait for Firebase to be ready ---
    document.addEventListener('DOMContentLoaded', () => {
        const waitForFirebase = setInterval(() => {
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                clearInterval(waitForFirebase);
                initVerify();
            }
        }, 300);
    });

    function initVerify() {
        const verifyBtn    = document.getElementById('verifyBtn');
        const slipInput    = document.getElementById('slipNumber');
        const verifyAnother = document.getElementById('verify-another');
        const printBtn     = document.getElementById('print-receipt');

        // Verify on button click
        verifyBtn.addEventListener('click', handleVerify);

        // Verify on Enter key
        slipInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleVerify();
        });

        // Verify another
        verifyAnother.addEventListener('click', () => {
            document.getElementById('verification-result').classList.add('d-none');
            document.getElementById('alert-container').innerHTML = '';
            slipInput.value = '';
            slipInput.focus();
        });

        // Print
        printBtn.addEventListener('click', () => window.print());
    }

    // --- Main Handler ---
    async function handleVerify() {
        if (locked) return;

        const rawInput = document.getElementById('slipNumber').value.trim();

        // 1. Sanitize input — only allow alphanumeric and basic punctuation
        const slipNo = rawInput.replace(/[^0-9]/g, ''); // digits only — stored as number in Firestore
        const slipNoNum = Number(slipNo); // convert to number for query

        if (!slipNo) {
            showAlert('warning', 'Please enter a slip number.');
            return;
        }

        if (slipNo.length < 2 || slipNo.length > 30) {
            showAlert('warning', 'Slip number must be between 2 and 30 characters.');
            return;
        }

        setLoading(true);
        document.getElementById('verification-result').classList.add('d-none');
        document.getElementById('alert-container').innerHTML = '';

        try {
            // 2. Query by slipNo field — limited to 1 result only
            const snapshot = await firebase.firestore()
                .collection('cr.vouchers')
                .where('slipNo', '==', slipNoNum)
                .limit(1)   // ← never fetch more than 1
                .get();

            if (snapshot.empty) {
                attempts++;
                handleFailedAttempt();
                showAlert('danger',
                    `<i class="fas fa-times-circle me-2"></i>
                     No receipt found for slip number <strong>${escapeHtml(slipNo)}</strong>.
                     Please check the number and try again.`
                );
            } else {
                // Success — reset attempts
                attempts = 0;
                hideAttemptWarnings();

                // 3. Only expose safe public fields
                const data = snapshot.docs[0].data();
                displayResult(data);
            }

        } catch (err) {
            console.error('Verify error:', err);
            showAlert('danger', 'Verification failed. Please try again later.');
        }

        setLoading(false);
    }

    // --- Display Result (safe fields only) ---
    function displayResult(data) {
        // Only show fields appropriate for public view
        setText('result-slipNo',        String(data.slipNo || '-'));
        setText('result-paymentFrom',   data.paymentFrom || '-');
        setText('result-pointPerson',   data.pointPerson || '-');
        setText('result-paymentMode',   data.paymentMode || '-');
        setText('result-cell',          data.cellNo || '-');
        setText('result-date',          data.paymentDate || formatTimestamp(data.entryDate));
        setText('result-paymentStatus', data.paymentStatus || '-');
        setText('result-user',          data.user || data.email || '-');
        setText('result-remarks',       data.remarks || '-');
        setText('result-totalCash',     formatAmount(data.cash || 0));

        // Denomination breakdown — uses flat fields: deno5000, deno1000, etc.
        const tbody = document.getElementById('result-denominations');
        tbody.innerHTML = '';
        const denoFields = [
            { label: '5000', field: 'deno5000' },
            { label: '1000', field: 'deno1000' },
            { label: '500',  field: 'deno500'  },
            { label: '100',  field: 'deno100'  },
            { label: '50',   field: 'deno50'   },
            { label: '20',   field: 'deno20'   },
            { label: '10',   field: 'deno10'   },
            { label: '1',    field: 'deno1'    },
        ];
        const activeDenoRows = denoFields.filter(dn => data[dn.field] && data[dn.field] > 0);
        if (activeDenoRows.length > 0) {
            activeDenoRows.forEach(dn => {
                const count = data[dn.field];
                const amt   = count * parseInt(dn.label);
                const row   = document.createElement('tr');
                row.innerHTML = `
                    <td>PKR ${dn.label}</td>
                    <td>${count}</td>
                    <td>${formatAmount(amt)}</td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-muted text-center">No breakdown available</td></tr>';
        }

        // Status badge
        const status = (data.paymentStatus || data.status || '').toLowerCase();
        const statusEl = document.getElementById('status-message');
        if (status === 'paid' || status === 'completed') {
            statusEl.className = 'verification-status alert alert-success';
            statusEl.innerHTML = '<i class="fas fa-check-circle me-2"></i><strong>VERIFIED</strong> — This is an authentic receipt.';
        } else if (status === 'pending') {
            statusEl.className = 'verification-status alert alert-warning';
            statusEl.innerHTML = '<i class="fas fa-clock me-2"></i><strong>PENDING</strong> — Payment is being processed.';
        } else {
            statusEl.className = 'verification-status alert alert-info';
            statusEl.innerHTML = '<i class="fas fa-info-circle me-2"></i><strong>FOUND</strong> — Receipt exists in the system.';
        }

        document.getElementById('verification-result').classList.remove('d-none');
    }

    // --- Rate Limiting ---
    function handleFailedAttempt() {
        if (attempts >= MAX_TRIES) {
            lockUser();
        } else if (attempts >= WARN_AFTER) {
            const remaining = MAX_TRIES - attempts;
            document.getElementById('attemptWarning').style.display = 'block';
            document.getElementById('attemptMsg').textContent =
                `${attempts} failed attempt(s). ${remaining} attempt(s) remaining before lockout.`;
        }
    }

    function lockUser() {
        locked = true;
        document.getElementById('verifyBtn').disabled = true;
        document.getElementById('slipNumber').disabled = true;
        document.getElementById('attemptWarning').style.display = 'none';
        document.getElementById('lockedMsg').style.display = 'block';

        let seconds = 60;
        document.getElementById('lockTimer').textContent = seconds;

        lockInterval = setInterval(() => {
            seconds--;
            document.getElementById('lockTimer').textContent = seconds;
            if (seconds <= 0) {
                clearInterval(lockInterval);
                locked   = false;
                attempts = 0;
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('slipNumber').disabled = false;
                document.getElementById('lockedMsg').style.display = 'none';
            }
        }, 1000);
    }

    function hideAttemptWarnings() {
        document.getElementById('attemptWarning').style.display = 'none';
        document.getElementById('lockedMsg').style.display = 'none';
    }

    // --- UI Helpers ---
    function setLoading(state) {
        const btn = document.getElementById('verifyBtn');
        btn.disabled = state;
        btn.innerHTML = state
            ? '<i class="fas fa-spinner fa-spin me-2"></i>Verifying...'
            : '<i class="fas fa-search me-2"></i>Verify';
    }

    function showAlert(type, msg) {
        document.getElementById('alert-container').innerHTML =
            `<div class="alert alert-${type} mt-2">${msg}</div>`;
    }

    function setText(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    function formatAmount(val) {
        const num = parseFloat(val) || 0;
        return 'PKR ' + num.toLocaleString('en-PK', { minimumFractionDigits: 2 });
    }

    function formatDate(val) {
        if (!val) return '-';
        try {
            // Handle Firestore Timestamp
            const d = val.toDate ? val.toDate() : new Date(val);
            return d.toLocaleDateString('en-PK', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch { return String(val); }
    }

    // Prevent XSS — escape any user-data before putting in HTML
    function formatTimestamp(val) {
        if (!val) return '-';
        try {
            const d = val.seconds ? new Date(val.seconds * 1000) : new Date(val);
            return d.toLocaleDateString('en-PK', { day: '2-digit', month: 'short', year: 'numeric' });
        } catch { return '-'; }
    }

    function escapeHtml(str) {
        return str.replace(/[&<>"']/g, c => ({
            '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
        }[c]));
    }
    </script>

</body>
</html>